<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>micro:bit UART WebBluetooth ãƒ†ã‚¹ãƒˆ</title>
<style>
    body { font-family: sans-serif; }
    #log { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; }
</style>
</head>
<body>

<h2>micro:bit UART WebBluetooth ãƒ†ã‚¹ãƒˆ</h2>

<button id="connect">ğŸ”µ æ¥ç¶š</button>
<button id="send" disabled>ğŸ“¤ é€ä¿¡(TEST)</button>

<div id="log"></div>

<script>
let device, server, uartService;
let txChar, rxChar;

function log(t) {
    document.querySelector("#log").textContent += t + "\n";
}

document.querySelector("#connect").onclick = async () => {
    try {
        log("ğŸ“¡ BLE ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œç´¢ä¸­â€¦");

        device = await navigator.bluetooth.requestDevice({
            filters: [{ namePrefix: "BBC micro:bit" }],
            optionalServices: [
                "6e400001-b5a3-f393-e0a9-e50e24dcca9e" // UART service
            ]
        });

        log("ğŸ”— ãƒ‡ãƒã‚¤ã‚¹é¸æŠ: " + device.name);
        server = await device.gatt.connect();

        log("ğŸ” ã‚µãƒ¼ãƒ“ã‚¹å–å¾—ä¸­â€¦");
        uartService = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");

        // RXï¼ˆæ›¸ãè¾¼ã¿ï¼‰
        rxChar = await uartService.getCharacteristic(
            "6e400002-b5a3-f393-e0a9-e50e24dcca9e"
        );

        // TXï¼ˆé€šçŸ¥ï¼‰
        txChar = await uartService.getCharacteristic(
            "6e400003-b5a3-f393-e0a9-e50e24dcca9e"
        );

        log("âœ” UART ã‚µãƒ¼ãƒ“ã‚¹å–å¾—æˆåŠŸ");

        // é€šçŸ¥é–‹å§‹
        await txChar.startNotifications();
        txChar.addEventListener("characteristicvaluechanged", e => {
            const text = new TextDecoder().decode(e.target.value);
            log("ğŸ“¥ RX: " + text);
        });
        log("âœ” é€šçŸ¥æœ‰åŠ¹åŒ– OK");

        document.querySelector("#send").disabled = false;

    } catch (e) {
        log("âŒ ã‚¨ãƒ©ãƒ¼: " + e);
    }
};


// é€ä¿¡ãƒœã‚¿ãƒ³
document.querySelector("#send").onclick = async () => {
    try {
        const data = new TextEncoder().encode("TEST\n");

        await rxChar.writeValueWithoutResponse(data);
        log("ğŸ“¤ TX: TEST");

    } catch (e) {
        log("âŒ æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + e);
    }
};
</script>

</body>
</html>
