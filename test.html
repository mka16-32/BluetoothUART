<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>micro:bit UART Auto Tester</title>
<style>
body { font-family: sans-serif; padding: 20px; }
button { padding: 10px 20px; border: none; background: #0078ff; color: #fff; border-radius: 6px; margin: 5px; }
#log { border: 1px solid #aaa; height: 300px; overflow-y: scroll; padding: 10px; white-space: pre; font-size: 14px; }
.ok { color: blue; }
.err { color: red; }
</style>
</head>
<body>

<h1>micro:bit UART Auto Tester</h1>
<button id="startBtn">Start Test</button>

<h3>Log</h3>
<div id="log"></div>

<p style="font-size:12px;color:#666;">Powered by ChatGPT</p>

<script>
let device;
let server;
let txChar, rxChar;

// ログ出力
function log(msg, ok=true) {
  const div = document.getElementById("log");
  const line = document.createElement("div");
  line.className = ok ? "ok" : "err";
  line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  div.appendChild(line);
  div.scrollTop = div.scrollHeight;
}

document.getElementById("startBtn").onclick = async () => {
  try {
    log("スキャン開始");

    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [
        "battery_service",
        "device_information",
        "6e400001-b5a3-f393-e0a9-e50e24dcca9e" // UART
      ]
    });

    log("デバイス検出: " + (device.name || "(名前なし)"));

    server = await device.gatt.connect();
    log("GATT接続成功");

    // サービス一覧表示
    const services = await server.getPrimaryServices();
    log("サービス一覧取得: " + services.length + "件");

    for (const s of services) {
      log("Service UUID: " + s.uuid);
    }

    // UART を取得
    let uartService;
    try {
      uartService = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
      log("UARTサービス取得成功");
    } catch {
      log("UART サービスがありません", false);
      return;
    }

    // TX
    try {
      txChar = await uartService.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e");
      log("TX characteristic OK");
    } catch (e) {
      log("TX characteristic エラー: " + e.message, false);
      return;
    }

    // RX
    try {
      rxChar = await uartService.getCharacteristic("6e400003-b5a3-f393-e0a9-e50e24dcca9e");
      log("RX characteristic OK");
    } catch (e) {
      log("RX characteristic エラー: " + e.message, false);
      return;
    }

    // 通知開始
    await rxChar.startNotifications();
    rxChar.addEventListener("characteristicvaluechanged", e => {
      const msg = new TextDecoder().decode(e.target.value);
      log("RX ← " + msg);
    });

    log("UART 受信通知開始");

    // PING テスト
    await txChar.writeValue(new TextEncoder().encode("PING"));
    log("TX → PING");

    // 切断イベント
    device.addEventListener("gattserverdisconnected", () => {
      log("切断されました");
    });

  } catch (e) {
    log("エラー: " + e.message, false);
  }
};
</script>

</body>
</html>
